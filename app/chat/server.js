const config = {
	server: {
		id: 'YaGameChatroom250919',
	},
	keys: SECRETS.KEYS,
	users: {
		Ya: {
			qq: '3415521417',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=3415521417&s=140', // Change s to 640 to switch to big images
		},
		我爱睡懒觉: {
			qq: '615154007',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=615154007&s=140',
		},
		技术进步: {
			qq: '3800034679',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=3800034679&s=140',
		},
		啦啦: {
			qq: '9138059',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=9138059&s=140',
		},
		百变小熊喵: {
			qq: '3223975172',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=3223975172&s=140',
		},
		guest: {
			qq: '669099770',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=669099770&s=140',
		},
		兔子: {
			qq: '319001907',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=319001907&s=140',
		},
		鱼头: {
			qq: '3354678595',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=3354678595&s=140',
		},
		MaidCarrot: {
			qq: '1291094437',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=1291094437&s=140',
		},
		saiwei: {
			qq: '372542780',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=372542780&s=140',
		},
		黑桃3: {
			qq: '806707508',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=806707508&s=140',
		},
		齐齐: {
			qq: '416390650',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=416390650&s=140',
		},
		Mithril: {
			qq: '2984304052',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=2984304052&s=140',
		},
		小口木: {
			qq: '2624078602',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=2928772532&s=140',
		},
		桌游小黄鸭: {
			qq: '550838367',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=550838367&s=140',
		},
		铁蛋: {
			qq: '2295824927',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=2295824927&s=140',
		},
		季风: {
			qq: '2756345902',
			avatar: 'https://i.imgs.ovh/2025/09/10/7CRv29.png',
		},
		帝: {
			qq: '2507614549',
			avatar: 'https://i.imgs.ovh/2025/09/12/7ZS6np.jpeg',
		},
		隐身鱼: {
			qq: '3293762834',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=3293762834&s=140',
		},
		生如夏花: {
			qq: '3840700357',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=3840700357&s=140',
		},
		CC1C: {
			qq: '2947058828',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=2947058828&s=140',
		},
		bore: {
			qq: '2890826151',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=2890826151&s=140',
		},
		苣屋逊太郎: {
			qq: '3312493298',
			avatar: 'https://static.wikia.nocookie.net/aliceinborderland/images/c/cf/Chishiya_%28OVA%29.jpg/revision/latest?cb=20250813171526',
		},
		L_light: {
			qq: '2648379526',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=2648379526&s=140',
		},
		Seven: {
			qq: '415048180',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=415048180&s=140',
		},
		CFaust: {
			qq: '2395603818',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=2395603818&s=140',
		},
		生草: {
			qq: '1242599483',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=1242599483&s=140',
		},
		西二旗四惠东: {
			qq: '2691677959',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=2691677959&s=140',
		},
		猫你太美: {
			qq: '2327980168',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=2327980168&s=140',
		},
		wine_slave: {
			qq: '3435730367',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=3435730367&s=140',
		},
		三月七: {
			qq: '1710445426',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=1710445426&s=140',
		},
		好姐妹燎火: {
			qq: '3360161171',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=3360161171&s=140',
		},
		好人: {
			qq: '1309287397',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=1309287397&s=140',
		},
		客都: {
			qq: '2318587834',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=2318587834&s=140',
		},
		防御塔: {
			qq: '939321072',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=939321072&s=140',
		},
		LongSea: {
			qq: '619167989',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=619167989&s=140',
		},
		Change: {
			qq: '3357982517',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=3357982517&s=140',
		},
		豆豆龙: {
			qq: '1605713334',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=1605713334&s=140',
		},
	},
	secretUsers: SECRETS.SECRET_USERS,
	maxMessages: 1000000000,
	agents: {
		小葵: {
			name: '小葵',
			qq: '2014627973',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=2014627973&s=140',

			trigger: ['小葵'],
			type: 'deepseek',
			reasoner: false,
			apikey: SECRETS.DEEPSEEK_API_KEY,
			maxMessages: 1000000000,
			persona: SECRETS.SUNFLOWER_PERSONA,
		},
		茉茉: {
			name: '茉茉',
			qq: '3795740926',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=3795740926&s=140',

			trigger: ['茉茉'],
			type: 'deepseek',
			reasoner: true,
			apikey: SECRETS.DEEPSEEK_API_KEY,
			maxMessages: 1000000000,
			persona: SECRETS.MOMO_PERSONA,
		},
		星铃: {
			name: '星铃',
			qq: '3854445263',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=3854445263&s=140',

			trigger: ['星铃'],
			type: 'deepseek',
			reasoner: false,
			apikey: SECRETS.DEEPSEEK_API_KEY,
			maxMessages: 1000000000,
			persona: SECRETS.STARRY_PERSONA,
		},
	},
	agentBlacklist: {
		齐齐: ['茉茉'],
	},
};

storage = createStorage('ls', 'YaGameChatroom', { msgs: [], msgs2: [], agents: {} });
storageData = storage.load();
agents = {};
for (const agent of Object.keys(config.agents)) {
	if (!storageData.agents.hasOwnProperty(agent)) {
		storageData.agents[agent] = {}
	}
	const createdAgent = createAgent(config.agents[agent], storageData.agents[agent]);
	createdAgent.output = function (message, isSecret) {
		inputToAgents(message.content, config.agents[agent].name);
		if (isSecret) {
			addMessage2(message);
		} else {
			addMessage(message);
		}
	};
	agents[agent] = createdAgent;
}
function inputToAgents(message, user = undefined) {
	for (const agent of Object.values(agents)) {
		agent.input(message, user);
	}
}

server = createServer('ws');
function addMessage(msg) {
	storageData.msgs.push(msg);
	if (storageData.msgs.length > config.maxMessages) {
		storageData.msgs = storageData.msgs.slice(-config.maxMessages);
	}
	storage.save();
	server.send({ type: 'msg', msg: msg });
	printMessage(msg);
}
function addMessage2(msg) {
	storageData.msgs2.push(msg);
	if (storageData.msgs2.length > config.maxMessages) {
		storageData.msgs2 = storageData.msgs2.slice(-config.maxMessages);
	}
	storage.save();
	for (const user of config.secretUsers) {
		server.send({ type: 'msg2', msg: msg }, user);
	}
	printMessage(msg);
}
time = undefined;
function checkTime() {
	const newTime = new Date();
	if (!time || newTime - time > 300000) {
		time = newTime;
		const timeString = time.toLocaleDateString() + ' ' + time.toLocaleTimeString();
		inputToAgents(`现在的时间是：${timeString}`);
		addMessage({
			type: 'system',
			content: timeString,
		});
	}
}
time2 = undefined;
function checkTime2() {
	const newTime = new Date();
	if (!time2 || newTime - time2 > 300000) {
		time2 = newTime;
		const timeString = time2.toLocaleDateString() + ' ' + time2.toLocaleTimeString();
		inputToAgents(`现在的时间是：${timeString}`);
		addMessage2({
			type: 'system',
			content: timeString,
		});
	}
}
function createMessage(msg, isSecret = false) {
	if (isSecret) {
		checkTime2();
		addMessage2(msg);
	} else {
		checkTime();
		addMessage(msg);
	}
	if (msg.type === 'usermsg') {
		// Input this message to agents
		const user = msg.user;
		inputToAgents(msg.content, user);

		// Check if any agent should be triggered
		for (const agent of Object.keys(config.agents)) {
			let ok = true;
			if (config.agentBlacklist[user]) {
				for (const item of config.agentBlacklist[user]) {
					if (item === 'all' || item === agent) {
						ok = !ok;
					}
				}
			}
			if (ok) {
				// User is not in blacklist, continue to check
				let trigger = false;
				for (const triggerWord of config.agents[agent].trigger) {
					if (msg.content.includes(triggerWord)) {
						trigger = true;
						break;
					}
				}
				if (trigger) {
					// Trigger this agent
					agents[agent].trigger(isSecret);
				}
			}
		}

		// Save state
		storage.save();
	}
}
server.open = function (id) {
	document.getElementById('serverid').classList.remove('red')
	document.getElementById('serverid').innerText = `服务器ID：${id}`;
	document.getElementById('serverinfo').classList.remove('hidden');
	for (const msg of storageData.msgs) {
		printMessage(msg);
	}
	// createMessage({ type: 'system', content: `服务器已启动，ID：${id}` });
};
server.receive = function (data, user) {
	if (typeof data !== 'object' || typeof data.type !== 'string') {
		server.send('Incorrect data format', user, true);
		return;
	}
	if (!config.users.hasOwnProperty(user)) {
		server.send('您不在该聊天室内', user, true);
		return;
	}
	switch (data.type) {
		case 'state':
			server.send({
				type: 'state',
				user: user,
				avatar: config.users[user].avatar,
				history: storageData.msgs,
			}, user);
			break;
		case 'msg':
			createMessage({
				type: 'usermsg',
				user: user,
				avatar: config.users[user].avatar,
				content: data.msg,
			});
			break;
		case 'state2':
			if (!config.secretUsers.includes(user)) {
				server.send('您不在该聊天室内', user, true);
				return;
			}
			server.send({
				type: 'state2',
				user: user,
				avatar: config.users[user].avatar,
				history: storageData.msgs2,
			}, user);
			break;
		case 'msg2':
			if (!config.secretUsers.includes(user)) {
				server.send('您不在该聊天室内', user, true);
				return;
			}
			createMessage({
				type: 'usermsg',
				user: user,
				avatar: config.users[user].avatar,
				content: data.msg,
			}, true);
			break;
		default:
			server.send(`Unknown data type ${data.type}`, user, true);
			break;
	}
};
server.close = function () {
	document.getElementById('serverid').classList.add('red')
	document.getElementById('serverid').innerText = '服务器已关闭';
	printError('服务器已关闭');
};
server.error = function (err) {
	printError(err);
};
onClosePage(function () {
	server.disconnect();
});
server.connect(config);