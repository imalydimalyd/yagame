const config = {
	server: {
		id: 'YaGameChatroom250919',
	},
	keys: SECRETS.KEYS,
	users: {
		Ya: {
			qq: '3415521417',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=3415521417&s=140', // Change s to 640 to switch to big images
		},
		æˆ‘çˆ±ç¡æ‡’è§‰: {
			qq: '615154007',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=615154007&s=140',
		},
		æŠ€æœ¯è¿›æ­¥: {
			qq: '3800034679',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=3800034679&s=140',
		},
		å•¦å•¦: {
			qq: '9138059',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=9138059&s=140',
		},
		ç™¾å˜å°ç†Šå–µ: {
			qq: '3223975172',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=3223975172&s=140',
		},
		guest: {
			qq: '669099770',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=669099770&s=140',
		},
		å…”å­: {
			qq: '319001907',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=319001907&s=140',
		},
		é±¼å¤´: {
			qq: '3354678595',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=3354678595&s=140',
		},
		MaidCarrot: {
			qq: '1291094437',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=1291094437&s=140',
		},
		saiwei: {
			qq: '372542780',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=372542780&s=140',
		},
		é»‘æ¡ƒ3: {
			qq: '806707508',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=806707508&s=140',
		},
		é½é½: {
			qq: '416390650',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=416390650&s=140',
		},
		Mithril: {
			qq: '2984304052',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=2984304052&s=140',
		},
		å°å£æœ¨: {
			qq: '2624078602',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=2928772532&s=140',
		},
		æ¡Œæ¸¸å°é»„é¸­: {
			qq: '550838367',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=550838367&s=140',
		},
		é“è›‹: {
			qq: '2295824927',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=2295824927&s=140',
		},
		å­£é£: {
			qq: '2756345902',
			avatar: 'https://i.imgs.ovh/2025/09/10/7CRv29.png',
		},
		å¸: {
			qq: '2507614549',
			avatar: 'https://i.imgs.ovh/2025/09/12/7ZS6np.jpeg',
		},
		éšèº«é±¼: {
			qq: '3293762834',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=3293762834&s=140',
		},
		CC1C: {
			qq: '2947058828',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=2947058828&s=140',
		},
		bore: {
			qq: '2890826151',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=2890826151&s=140',
		},
		è‹£å±‹é€Šå¤ªéƒ: {
			qq: '3312493298',
			avatar: 'https://static.wikia.nocookie.net/aliceinborderland/images/c/cf/Chishiya_%28OVA%29.jpg/revision/latest?cb=20250813171526',
		},
		L_light: {
			qq: '2648379526',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=2648379526&s=140',
		},
		Seven: {
			qq: '415048180',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=415048180&s=140',
		},
		CFaust: {
			qq: '2395603818',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=2395603818&s=140',
		},
		ç”Ÿè‰: {
			qq: '1242599483',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=1242599483&s=140',
		},
		è¥¿äºŒæ——å››æƒ ä¸œ: {
			qq: '2691677959',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=2691677959&s=140',
		},
		çŒ«ä½ å¤ªç¾: {
			qq: '2327980168',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=2327980168&s=140',
		},
		wine_slave: {
			qq: '3435730367',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=3435730367&s=140',
		},
		ä¸‰æœˆä¸ƒ: {
			qq: '1710445426',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=1710445426&s=140',
		},
		å¥½å§å¦¹ç‡ç«: {
			qq: '3360161171',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=3360161171&s=140',
		},
		å¥½äºº: {
			qq: '1309287397',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=1309287397&s=140',
		},
		å®¢éƒ½: {
			qq: '2318587834',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=2318587834&s=140',
		},
		é˜²å¾¡å¡”: {
			qq: '939321072',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=939321072&s=140',
		},
		LongSea: {
			qq: '619167989',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=619167989&s=140',
		},
		Change: {
			qq: '3357982517',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=3357982517&s=140',
		},
		è±†è±†é¾™: {
			qq: '1605713334',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=1605713334&s=140',
		},
		jiaohu: {
			qq: '368305848',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=368305848&s=140',
		},
		ç¥å¥‡ç´«æ™¶: {
			qq: '792821385',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=792821385&s=140',
		},
	},
	secretUsers: SECRETS.SECRET_USERS,
	maxMessages: 1000000000,
	agents: {
		å°è‘µ: {
			name: 'å°è‘µ',
			qq: '2014627973',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=2014627973&s=140',

			trigger: ['å°è‘µ'],
			type: 'deepseek',
			reasoner: false,
			showCOT: false,
			apikey: SECRETS.DEEPSEEK_API_KEY,
			maxMessages: 1000000000,
			persona: SECRETS.SUNFLOWER_PERSONA,

			sleepTime: 59000000,
			dreamProb: 0.5,
		},
		èŒ‰èŒ‰: {
			name: 'èŒ‰èŒ‰',
			qq: '3795740926',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=3795740926&s=640',

			trigger: ['èŒ‰èŒ‰', 'å˜', 'è±†è±†é¾™'],
			type: 'deepseek',
			reasoner: true,
			showCOT: false,
			apikey: SECRETS.DEEPSEEK_API_KEY,
			maxMessages: 1000000000,
			persona: SECRETS.MOMO_PERSONA,

			sleepTime: 57000000,
			dreamProb: 0.5,
		},
		æ˜Ÿé“ƒ: {
			name: 'æ˜Ÿé“ƒ',
			qq: '3854445263',
			avatar: 'https://q1.qlogo.cn/g?b=qq&nk=3854445263&s=140',

			trigger: ['æ˜Ÿé“ƒ'],
			type: 'deepseek',
			reasoner: false,
			showCOT: false,
			apikey: SECRETS.DEEPSEEK_API_KEY,
			maxMessages: 1000000000,
			persona: SECRETS.STARRY_PERSONA,

			sleepTime: 58000000,
			dreamProb: 0.5,
		},
	},
	agentBlacklist: {
		é½é½: ['èŒ‰èŒ‰'],
	},
};

storage = createStorage('ls', 'YaGameChatroom', { timestamp: 0, timestamp2: 0, msgs: [], msgs2: [], agents: {} });
storageData = storage.load();
agents = {};
for (const agent of Object.keys(config.agents)) {
	if (!storageData.agents.hasOwnProperty(agent)) {
		storageData.agents[agent] = {}
	}
	const createdAgent = createAgent(config.agents[agent], storageData.agents[agent]);
	createdAgent.output = function (message, isSecret) {
		createMessage(message, isSecret, true);
	};
	createdAgent.log = function (message, isSecret) {
		if (isSecret) {
			addMessage2(message);
		}
	};
	createdAgent.finishSleep = function () {
		storage.save();
	};
	agents[agent] = createdAgent;
}
function inputToAgents(message, user = undefined) {
	for (const agent of Object.values(agents)) {
		agent.input(message, user);
	}
}

server = createServer('ws');
function addMessage(msg) {
	msg.timestamp = (++storageData.timestamp);
	storageData.msgs.push(msg);
	if (storageData.msgs.length > config.maxMessages) {
		storageData.msgs = storageData.msgs.slice(-config.maxMessages);
	}
	storage.save();
	server.send({ type: 'msg', msg: msg });
	// printMessage(msg);
}
function addMessage2(msg) {
	msg.timestamp = (++storageData.timestamp2);
	storageData.msgs2.push(msg);
	if (storageData.msgs2.length > config.maxMessages) {
		storageData.msgs2 = storageData.msgs2.slice(-config.maxMessages);
	}
	storage.save();
	for (const user of config.secretUsers) {
		server.send({ type: 'msg2', msg: msg }, user);
	}
	// printMessage(msg);
}
time = undefined;
function checkTime() {
	const newTime = new Date();
	if (!time || newTime - time > 300000) {
		time = newTime;
		const timeString = time.toLocaleDateString() + ' ' + time.toLocaleTimeString();
		inputToAgents(`ç°åœ¨çš„æ—¶é—´æ˜¯ï¼š${timeString}`);
		addMessage({
			type: 'system',
			content: timeString,
		});
	}
}
time2 = undefined;
function checkTime2() {
	const newTime = new Date();
	if (!time2 || newTime - time2 > 300000) {
		time2 = newTime;
		const timeString = time2.toLocaleDateString() + ' ' + time2.toLocaleTimeString();
		inputToAgents(`ç°åœ¨çš„æ—¶é—´æ˜¯ï¼š${timeString}`);
		addMessage2({
			type: 'system',
			content: timeString,
		});
	}
}
function createMessage(msg, isSecret = false, isAgentMessage = false) {
	if (isSecret) {
		checkTime2();
		addMessage2(msg);
	} else {
		checkTime();
		addMessage(msg);
	}
	if (msg.type === 'usermsg' && !msg.content.includes('ğŸ›‘')) {
		// Input this message to agents
		const user = msg.user;
		inputToAgents(msg.content, user);

		// Check if any agent should be triggered
		for (const agent of Object.keys(config.agents)) {
			if (agent === user) {
				continue;
			}
			let ok = true;
			if (config.agentBlacklist[user]) {
				for (const item of config.agentBlacklist[user]) {
					if (item === 'all' || item === agent) {
						ok = !ok;
					}
				}
			}
			if (ok) {
				// User is not in blacklist, continue to check
				let trigger = false;
				for (const triggerWord of config.agents[agent].trigger) {
					if (msg.content.includes(triggerWord)) {
						trigger = true;
						break;
					}
				}
				if (trigger) {
					// Trigger this agent
					agents[agent].trigger(isSecret, isAgentMessage);
				}
			}
		}
	}

	// Save state
	storage.save();
}
server.open = function (id) {
	document.getElementById('serverid').classList.remove('red')
	document.getElementById('serverid').innerText = `æœåŠ¡å™¨IDï¼š${id}`;
	document.getElementById('serverinfo').classList.remove('hidden');
	printMessage({ type: 'system', content: `æœåŠ¡å™¨å·²å¯åŠ¨ï¼ŒIDï¼š${id}` });
};
server.receive = function (data, user) {
	if (typeof data !== 'object' || typeof data.type !== 'string') {
		server.send('Incorrect data format', user, true);
		return;
	}
	if (!config.users.hasOwnProperty(user)) {
		server.send('æ‚¨ä¸åœ¨è¯¥èŠå¤©å®¤å†…', user, true);
		return;
	}
	switch (data.type) {
		case 'state':
			server.send({
				type: 'state',
				user: user,
				avatar: config.users[user].avatar,
				history: storageData.msgs.filter(function (x) { return x.timestamp > data.timestamp; }),
				timestamp: storageData.timestamp,
			}, user);
			break;
		case 'msg':
			createMessage({
				type: 'usermsg',
				user: user,
				avatar: config.users[user].avatar,
				content: data.msg,
			});
			break;
		case 'state2':
			if (!config.secretUsers.includes(user)) {
				server.send('æ‚¨ä¸åœ¨è¯¥èŠå¤©å®¤å†…', user, true);
				return;
			}
			server.send({
				type: 'state2',
				user: user,
				avatar: config.users[user].avatar,
				history: storageData.msgs2.filter(function (x) { return x.timestamp > data.timestamp; }),
				timestamp: storageData.timestamp2,
			}, user);
			break;
		case 'msg2':
			if (!config.secretUsers.includes(user)) {
				server.send('æ‚¨ä¸åœ¨è¯¥èŠå¤©å®¤å†…', user, true);
				return;
			}
			createMessage({
				type: 'usermsg',
				user: user,
				avatar: config.users[user].avatar,
				content: data.msg,
			}, true);
			break;
		default:
			server.send(`Unknown data type ${data.type}`, user, true);
			break;
	}
};
server.close = function () {
	document.getElementById('serverid').classList.add('red')
	document.getElementById('serverid').innerText = 'æœåŠ¡å™¨å·²å…³é—­';
	printError('æœåŠ¡å™¨å·²å…³é—­');
};
server.error = function (err) {
	printError(err);
};
onClosePage(function () {
	server.disconnect();
});
server.connect(config);